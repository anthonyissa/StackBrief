# StackBrief - Knowledge Base

### MANDATORY

ALWAYS UPDATE THIS FILE IF NEEDED AFTER AN EDIT IN THE PROJECT.

> ğŸ“Œ **Cursor Context File** - Always apply this context when working on this project.

## ğŸ¯ Project Overview

**StackBrief** is a Substack newsletter aggregator and summarizer that delivers AI-powered digests directly to users via Telegram notifications.

### Core Value Proposition

Transform lengthy Substack newsletters into **bite-sized, emoji-rich bullet points** that are easy to read on-the-go, with a link to the full article for deeper reading.

---

## ğŸ—ï¸ Architecture

### Current Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           STACKBRIEF                                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Config  â”‚â”€â”€â”€â”€â–¶â”‚    Engine    â”‚â”€â”€â”€â”€â–¶â”‚   OpenAI    â”‚â”€â”€â”€â”€â–¶â”‚Telegram â”‚â”‚
â”‚  â”‚  (env)   â”‚     â”‚  (Cron Job)  â”‚     â”‚ Summarizer  â”‚     â”‚   Bot   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                  â”‚                    â”‚                  â”‚     â”‚
â”‚       â”‚                  â–¼                    â”‚                  â”‚     â”‚
â”‚       â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                  â”‚     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  PostgreSQL  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚     â”‚
â”‚                  â”‚   Database   â”‚                                â”‚     â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚     â”‚
â”‚                         â”‚                                        â”‚     â”‚
â”‚                         â–¼                                        â”‚     â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚     â”‚
â”‚               â”‚  Substack API    â”‚                               â”‚     â”‚
â”‚               â”‚    Client        â”‚                               â”‚     â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Implemented Features

### 1. âœ… Configuration System (`src/config.ts`)

Environment-based configuration with:
- List of Substack newsletters to follow
- Telegram Bot token & Chat ID
- Cron interval settings
- OpenAI API settings (key, model, temperature)
- PostgreSQL database URL

### 2. âœ… Substack API Client (`src/substack-api/`)

Complete TypeScript port of the Python substack_api library:
- `Newsletter` class - fetch posts, search, podcasts, recommendations, authors
- `Post` class - metadata, HTML content, plain text content, paywall detection
- `User` class - profile data, subscriptions, handle redirects
- `Category` class - browse newsletters by category
- `SubstackAuth` class - cookie-based authentication for paywalled content

### 3. âœ… Database Layer (`src/database/`)

PostgreSQL database with:
- **posts** table - stores all fetched posts with content
- **newsletters** table - tracks monitored newsletters
- **migrations** table - schema versioning
- Duplicate detection by post_id and slug
- Auto-initialization on startup

### 4. âœ… AI Summarization (`src/openai/`)

OpenAI-powered summarization:
- Generates 4 emoji-rich bullet points per post
- Configurable model (default: gpt-4o-mini)
- Fallback to basic extraction if AI unavailable
- Content truncation for token management

### 5. âœ… Telegram Bot Integration (`src/telegram/`)

Full Telegram Bot API integration:
- Send individual digest items
- Send combined digests
- HTML message formatting
- Rate limiting protection
- Connection testing

### 6. âœ… Engine & Scheduler (`src/engine.ts`)

Main orchestration with:
- Cron-based scheduling (configurable interval)
- Process all newsletters in sequence
- Duplicate detection before processing
- Graceful shutdown handling

---

## ğŸ”§ Tech Stack

| Component        | Technology                |
| ---------------- | ------------------------- |
| Runtime          | Bun                       |
| Language         | TypeScript (strict mode)  |
| Substack Client  | Custom (TypeScript)       |
| Database         | PostgreSQL + `postgres`   |
| AI               | OpenAI API (`openai`)     |
| Telegram         | Custom client (fetch API) |
| Scheduler        | Native `setInterval`      |
| Config           | Environment variables     |

---

## ğŸ“‚ File Structure

```
src/
â”œâ”€â”€ index.ts              # Re-exports substack-api
â”œâ”€â”€ config.ts             # App configuration from env
â”œâ”€â”€ engine.ts             # Main engine & cron scheduler
â”œâ”€â”€ run-once.ts           # Single run (no cron)
â”œâ”€â”€ test.ts               # API test script
â”‚
â”œâ”€â”€ substack-api/         # âœ… Substack API Client
â”‚   â”œâ”€â”€ index.ts          # Exports
â”‚   â”œâ”€â”€ types.ts          # TypeScript interfaces
â”‚   â”œâ”€â”€ constants.ts      # Headers, URLs, defaults
â”‚   â”œâ”€â”€ auth.ts           # SubstackAuth class
â”‚   â”œâ”€â”€ newsletter.ts     # Newsletter class
â”‚   â”œâ”€â”€ post.ts           # Post class
â”‚   â”œâ”€â”€ user.ts           # User class
â”‚   â””â”€â”€ category.ts       # Category class
â”‚
â”œâ”€â”€ database/             # âœ… PostgreSQL Database
â”‚   â”œâ”€â”€ index.ts          # Exports
â”‚   â”œâ”€â”€ types.ts          # Database types
â”‚   â”œâ”€â”€ init.ts           # Schema initialization
â”‚   â””â”€â”€ queries.ts        # CRUD operations
â”‚
â”œâ”€â”€ openai/               # âœ… AI Summarization
â”‚   â”œâ”€â”€ index.ts          # Exports
â”‚   â”œâ”€â”€ types.ts          # OpenAI types
â”‚   â”œâ”€â”€ constants.ts      # Prompts, defaults
â”‚   â””â”€â”€ client.ts         # OpenAIClient class
â”‚
â””â”€â”€ telegram/             # âœ… Telegram Bot
    â”œâ”€â”€ index.ts          # Exports
    â”œâ”€â”€ types.ts          # Telegram types
    â”œâ”€â”€ constants.ts      # API URLs, limits
    â””â”€â”€ client.ts         # TelegramClient class
```

---

## âš™ï¸ Environment Variables

```env
# Database (PostgreSQL)
DATABASE_URL=postgres://user:pass@host:5432/dbname

# Telegram Bot
TELEGRAM_BOT_TOKEN=your-bot-token
TELEGRAM_CHAT_ID=your-chat-id

# OpenAI
OPENAI_API_KEY=your-openai-key
OPENAI_MODEL=gpt-4o-mini  # optional, default: gpt-4o-mini
```

---

## ğŸš€ NPM Scripts

| Command           | Description                          |
| ----------------- | ------------------------------------ |
| `bun run start`   | Start cron scheduler (runs forever)  |
| `bun run job`     | Run once (no cron)                   |
| `bun run test`    | Run API test script                  |
| `bun run typecheck` | TypeScript type checking           |

---

## ğŸ“ Telegram Message Format

```
ğŸ“° Newsletter Name (21/01/2026)
Post Title

â€¢ ğŸ”‘ Key point one from the article
â€¢ ğŸ’¡ Important insight or idea
â€¢ ğŸ“Š Any data or statistics mentioned
â€¢ ğŸ¯ Main takeaway or conclusion

ğŸ”— Read full article
```

---

## ğŸ”„ Workflow

1. **Startup**: 
   - Load config from environment
   - Initialize PostgreSQL connection
   - Create tables if not exist
   - Initialize OpenAI & Telegram clients

2. **Job Run** (cron or manual):
   - For each configured newsletter:
     - Fetch latest N posts from Substack
     - For each post:
       - Check if already in database
       - If new: fetch full content
       - Save to database
       - Generate AI summary (if enabled)
       - Send Telegram notification (if enabled)
   - Log summary statistics

3. **Repeat**: Wait for next cron interval

---

## ğŸ“Œ Key Types Reference

```typescript
// Processed post (engine.ts)
interface ProcessedPost {
  newsletterName: string;
  newsletterUrl: string;
  postId: number;
  slug: string;
  title: string;
  subtitle?: string;
  url: string;
  date: string;
  content: string | null;
  wordCount?: number;
  isPaywalled: boolean;
}

// Digest item for Telegram (telegram/types.ts)
interface DigestItem {
  newsletterName: string;
  title: string;
  url: string;
  bulletPoints: string[];
  date?: string;
}

// App configuration (config.ts)
interface AppConfig {
  substacks: SubstackConfig[];
  cronIntervalMinutes: number;
  postsPerNewsletter: number;
  telegram: { enabled, botToken, chatId };
  database: { enabled, url };
  openai: { enabled, apiKey, model, maxTokens, temperature };
}
```

---

## ğŸ¨ Design Principles

1. **Simplicity First**: Keep the digest short and scannable
2. **Mobile-Friendly**: Optimized for Telegram on mobile
3. **Non-Intrusive**: Respect user attention with quality over quantity
4. **Reliable**: Never send duplicates, handle failures gracefully
5. **Configurable**: Easy to add/remove newsletters via config

---

## ğŸ“‹ Development Guidelines

- Write code in **English** (comments, variables, errors)
- Use TypeScript **strict mode**
- Follow **Clean Code** practices
- Add comprehensive **logging** for debugging
- Prefer **readability** over premature optimization
- All database operations are **async**
- Handle errors gracefully with fallbacks

---

## âœ… MVP Status

| Feature               | Status |
| --------------------- | ------ |
| Substack API Client   | âœ… Done |
| Configuration System  | âœ… Done |
| PostgreSQL Database   | âœ… Done |
| OpenAI Summarization  | âœ… Done |
| Telegram Integration  | âœ… Done |
| Cron Scheduler        | âœ… Done |
| Main Engine           | âœ… Done |

---

## ğŸ”— API Endpoints Used

| Endpoint | Purpose |
|----------|---------|
| `{url}/api/v1/archive` | Get newsletter posts |
| `{url}/api/v1/posts/{slug}` | Get single post data |
| `{url}/api/v1/recommendations/from/{id}` | Get recommendations |
| `{url}/api/v1/publication/users/ranked` | Get authors |
| `https://substack.com/api/v1/user/{username}/public_profile` | User profile |
| `https://substack.com/api/v1/categories` | List categories |
| `https://substack.com/api/v1/category/public/{id}/all` | Category newsletters |
| `https://substack.com/api/v1/publication/search` | Search publications |
